// Jest Snapshot v1, https://goo.gl/fbAQLP

exports[`The support-workers stack matches the snapshot 1`] = `
{
  "Metadata": {
    "gu:cdk:constructs": [
      "GuDistributionBucketParameter",
      "GuLambdaFunction",
      "GuLambdaFunction",
      "GuLambdaFunction",
      "GuLambdaFunction",
      "GuLambdaFunction",
      "GuLambdaFunction",
      "GuLambdaFunction",
      "GuLambdaFunction",
    ],
    "gu:cdk:version": "TEST",
  },
  "Parameters": {
    "DistributionBucketName": {
      "Default": "/account/services/artifact.bucket",
      "Description": "SSM parameter containing the S3 bucket name holding distribution artifacts",
      "Type": "AWS::SSM::Parameter::Value<String>",
    },
  },
  "Resources": {
    "CreatePaymentMethodLambda": {
      "DependsOn": [
        "CreatePaymentMethodLambdaServiceRoleDefaultPolicyFF0C6A6A",
        "CreatePaymentMethodLambdaServiceRole2642162E",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-CreatePaymentMethodLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.CreatePaymentMethod::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "CreatePaymentMethodLambdaServiceRole2642162E",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CreatePaymentMethodLambdaServiceRole2642162E": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CreatePaymentMethodLambdaServiceRoleDefaultPolicyFF0C6A6A": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CreatePaymentMethodLambdaServiceRoleDefaultPolicyFF0C6A6A",
        "Roles": [
          {
            "Ref": "CreatePaymentMethodLambdaServiceRole2642162E",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CreateSalesforceContactLambda": {
      "DependsOn": [
        "CreateSalesforceContactLambdaServiceRoleDefaultPolicy3E0944ED",
        "CreateSalesforceContactLambdaServiceRole68D44BEC",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-CreateSalesforceContactLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.CreateSalesforceContact::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "CreateSalesforceContactLambdaServiceRole68D44BEC",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CreateSalesforceContactLambdaServiceRole68D44BEC": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CreateSalesforceContactLambdaServiceRoleDefaultPolicy3E0944ED": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CreateSalesforceContactLambdaServiceRoleDefaultPolicy3E0944ED",
        "Roles": [
          {
            "Ref": "CreateSalesforceContactLambdaServiceRole68D44BEC",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "CreateZuoraSubscriptionLambda": {
      "DependsOn": [
        "CreateZuoraSubscriptionLambdaServiceRoleDefaultPolicy82F26782",
        "CreateZuoraSubscriptionLambdaServiceRole56164E38",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-CreateZuoraSubscriptionLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.CreateZuoraSubscription::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "CreateZuoraSubscriptionLambdaServiceRole56164E38",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "CreateZuoraSubscriptionLambdaServiceRole56164E38": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "CreateZuoraSubscriptionLambdaServiceRoleDefaultPolicy82F26782": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "dynamodb:GetItem",
                "dynamodb:Scan",
                "dynamodb:Query",
                "dynamodb:DescribeTable",
              ],
              "Effect": "Allow",
              "Resource": [
                "arn:aws:dynamodb:*:*:table/MembershipSub-Promotions-CODE",
                "arn:aws:dynamodb:*:*:table/MembershipSub-Promotions-PROD",
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "CreateZuoraSubscriptionLambdaServiceRoleDefaultPolicy82F26782",
        "Roles": [
          {
            "Ref": "CreateZuoraSubscriptionLambdaServiceRole56164E38",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "FailureHandlerLambda": {
      "DependsOn": [
        "FailureHandlerLambdaServiceRoleDefaultPolicyC42C7F6D",
        "FailureHandlerLambdaServiceRole6F65E37D",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-FailureHandlerLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.FailureHandler::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "FailureHandlerLambdaServiceRole6F65E37D",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "FailureHandlerLambdaServiceRole6F65E37D": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "FailureHandlerLambdaServiceRoleDefaultPolicyC42C7F6D": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "sqs:GetQueueUrl",
                "sqs:SendMessage",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::ImportValue": "comms-PROD-EmailQueueArn",
              },
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "FailureHandlerLambdaServiceRoleDefaultPolicyC42C7F6D",
        "Roles": [
          {
            "Ref": "FailureHandlerLambdaServiceRole6F65E37D",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "PreparePaymentMethodForReuseLambda": {
      "DependsOn": [
        "PreparePaymentMethodForReuseLambdaServiceRoleDefaultPolicyC8E31FA5",
        "PreparePaymentMethodForReuseLambdaServiceRoleC402A494",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-PreparePaymentMethodForReuseLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.PreparePaymentMethodForReuse::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "PreparePaymentMethodForReuseLambdaServiceRoleC402A494",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "PreparePaymentMethodForReuseLambdaServiceRoleC402A494": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "PreparePaymentMethodForReuseLambdaServiceRoleDefaultPolicyC8E31FA5": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "PreparePaymentMethodForReuseLambdaServiceRoleDefaultPolicyC8E31FA5",
        "Roles": [
          {
            "Ref": "PreparePaymentMethodForReuseLambdaServiceRoleC402A494",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SendAcquisitionEventLambda": {
      "DependsOn": [
        "SendAcquisitionEventLambdaServiceRoleDefaultPolicyE1B7229D",
        "SendAcquisitionEventLambdaServiceRole9BF3677F",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-SendAcquisitionEventLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.SendAcquisitionEvent::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "SendAcquisitionEventLambdaServiceRole9BF3677F",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "SendAcquisitionEventLambdaServiceRole9BF3677F": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SendAcquisitionEventLambdaServiceRoleDefaultPolicyE1B7229D": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": "events:PutEvents",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:events:eu-west-1:865473395570:event-bus/acquisitions-bus-CODE",
                "arn:aws:events:eu-west-1:865473395570:event-bus/acquisitions-bus-PROD",
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "SendAcquisitionEventLambdaServiceRoleDefaultPolicyE1B7229D",
        "Roles": [
          {
            "Ref": "SendAcquisitionEventLambdaServiceRole9BF3677F",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SendThankYouEmailLambda": {
      "DependsOn": [
        "SendThankYouEmailLambdaServiceRoleDefaultPolicyE7275287",
        "SendThankYouEmailLambdaServiceRoleE8E08BFF",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-SendThankYouEmailLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.SendThankYouEmail::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "SendThankYouEmailLambdaServiceRoleE8E08BFF",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "SendThankYouEmailLambdaServiceRoleDefaultPolicyE7275287": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "sqs:GetQueueUrl",
                "sqs:SendMessage",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::ImportValue": "comms-PROD-EmailQueueArn",
              },
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "SendThankYouEmailLambdaServiceRoleDefaultPolicyE7275287",
        "Roles": [
          {
            "Ref": "SendThankYouEmailLambdaServiceRoleE8E08BFF",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "SendThankYouEmailLambdaServiceRoleE8E08BFF": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SupportWorkersPROD": {
      "DeletionPolicy": "Delete",
      "DependsOn": [
        "SupportWorkersRoleDefaultPolicyCB757939",
        "SupportWorkersRole33385BA0",
      ],
      "Properties": {
        "DefinitionString": {
          "Fn::Join": [
            "",
            [
              "{"StartAt":"ShouldClonePaymentMethodChoice","States":{"ShouldClonePaymentMethodChoice":{"Type":"Choice","Choices":[{"Variable":"$.requestInfo.accountExists","BooleanEquals":true,"Next":"PreparePaymentMethodForReuse"}],"Default":"CreatePaymentMethod"},"CreatePaymentMethod":{"Next":"CreateSalesforceContact","Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Catch":[{"ErrorEquals":["States.TaskFailed"],"ResultPath":"$.error","Next":"FailureHandler"}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "CreatePaymentMethodLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}},"CreateSalesforceContact":{"Next":"CreateZuoraSubscription","Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Catch":[{"ErrorEquals":["States.TaskFailed"],"ResultPath":"$.error","Next":"FailureHandler"}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "CreateSalesforceContactLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}},"CreateZuoraSubscription":{"Next":"Parallel","Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Catch":[{"ErrorEquals":["States.TaskFailed"],"ResultPath":"$.error","Next":"FailureHandler"}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "CreateZuoraSubscriptionLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}},"PreparePaymentMethodForReuse":{"Next":"CreateZuoraSubscription","Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Catch":[{"ErrorEquals":["States.TaskFailed"],"ResultPath":"$.error","Next":"FailureHandler"}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "PreparePaymentMethodForReuseLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}},"FailureHandler":{"Next":"SucceedOrFailChoice","Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "FailureHandlerLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}},"SucceedOrFailChoice":{"Type":"Choice","Choices":[{"Variable":"$.requestInfo.testUser","BooleanEquals":true,"Next":"CheckoutFailure"},{"Variable":"$.requestInfo.failed","BooleanEquals":true,"Next":"FailState"}],"Default":"CheckoutFailure"},"CheckoutFailure":{"Type":"Pass","End":true},"FailState":{"Type":"Fail"},"Parallel":{"Type":"Parallel","End":true,"Branches":[{"StartAt":"SendThankYouEmail","States":{"SendThankYouEmail":{"End":true,"Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "SendThankYouEmailLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}}}},{"StartAt":"UpdateSupporterProductData","States":{"UpdateSupporterProductData":{"End":true,"Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "UpdateSupporterProductDataLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}}}},{"StartAt":"SendAcquisitionEvent","States":{"SendAcquisitionEvent":{"End":true,"Retry":[{"ErrorEquals":["Lambda.ClientExecutionTimeoutException","Lambda.ServiceException","Lambda.AWSLambdaException","Lambda.SdkClientException"],"IntervalSeconds":2,"MaxAttempts":6,"BackoffRate":2},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryNone"],"MaxAttempts":0},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryLimited"],"IntervalSeconds":1,"MaxAttempts":5,"BackoffRate":10},{"ErrorEquals":["com.gu.support.workers.exceptions.RetryUnlimited"],"IntervalSeconds":1,"MaxAttempts":999999,"BackoffRate":2},{"ErrorEquals":["States.ALL"],"IntervalSeconds":3,"MaxAttempts":999999,"BackoffRate":2}],"Type":"Task","OutputPath":"$.Payload","Resource":"arn:",
              {
                "Ref": "AWS::Partition",
              },
              ":states:::lambda:invoke","Parameters":{"FunctionName":"",
              {
                "Fn::GetAtt": [
                  "SendAcquisitionEventLambda",
                  "Arn",
                ],
              },
              "","Payload.$":"$"}}}},{"StartAt":"CheckoutSuccess","States":{"CheckoutSuccess":{"Type":"Succeed"}}}]}}}",
            ],
          ],
        },
        "RoleArn": {
          "Fn::GetAtt": [
            "SupportWorkersRole33385BA0",
            "Arn",
          ],
        },
        "StateMachineName": "support-workers-PROD",
        "Tags": [
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::StepFunctions::StateMachine",
      "UpdateReplacePolicy": "Delete",
    },
    "SupportWorkersRole33385BA0": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "states.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "Tags": [
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "SupportWorkersRoleDefaultPolicyCB757939": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "CreatePaymentMethodLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "CreatePaymentMethodLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "CreateSalesforceContactLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "CreateSalesforceContactLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "CreateZuoraSubscriptionLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "CreateZuoraSubscriptionLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "PreparePaymentMethodForReuseLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "PreparePaymentMethodForReuseLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "FailureHandlerLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "FailureHandlerLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "SendThankYouEmailLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "SendThankYouEmailLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "UpdateSupporterProductDataLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "UpdateSupporterProductDataLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "lambda:InvokeFunction",
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::GetAtt": [
                    "SendAcquisitionEventLambda",
                    "Arn",
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      {
                        "Fn::GetAtt": [
                          "SendAcquisitionEventLambda",
                          "Arn",
                        ],
                      },
                      ":*",
                    ],
                  ],
                },
              ],
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "SupportWorkersRoleDefaultPolicyCB757939",
        "Roles": [
          {
            "Ref": "SupportWorkersRole33385BA0",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
    "UpdateSupporterProductDataLambda": {
      "DependsOn": [
        "UpdateSupporterProductDataLambdaServiceRoleDefaultPolicyBD75E0D4",
        "UpdateSupporterProductDataLambdaServiceRole6A1FC129",
      ],
      "Properties": {
        "Code": {
          "S3Bucket": {
            "Ref": "DistributionBucketName",
          },
          "S3Key": "support/PROD/support-workers/support-workers.jar",
        },
        "Environment": {
          "Variables": {
            "APP": "support-workers",
            "EMAIL_QUEUE_NAME": {
              "Fn::ImportValue": "comms-PROD-EmailQueueName",
            },
            "GU_SUPPORT_WORKERS_STAGE": "PROD",
            "SENTRY_DSN": "https://55945d73ad654abd856d1523de4f9d56:cf9b33aaff3c483899dfa986abce55df@sentry.io/1212214",
            "SENTRY_ENVIRONMENT": "PROD",
            "STACK": "support",
            "STAGE": "PROD",
          },
        },
        "FunctionName": "support-UpdateSupporterProductDataLambda-PROD",
        "Handler": "com.gu.support.workers.lambdas.UpdateSupporterProductData::handleRequest",
        "LoggingConfig": {
          "LogFormat": "JSON",
        },
        "MemorySize": 1024,
        "Role": {
          "Fn::GetAtt": [
            "UpdateSupporterProductDataLambdaServiceRole6A1FC129",
            "Arn",
          ],
        },
        "Runtime": "java21",
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
        "Timeout": 300,
      },
      "Type": "AWS::Lambda::Function",
    },
    "UpdateSupporterProductDataLambdaServiceRole6A1FC129": {
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "lambda.amazonaws.com",
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "ManagedPolicyArns": [
          {
            "Fn::Join": [
              "",
              [
                "arn:",
                {
                  "Ref": "AWS::Partition",
                },
                ":iam::aws:policy/service-role/AWSLambdaBasicExecutionRole",
              ],
            ],
          },
        ],
        "Tags": [
          {
            "Key": "App",
            "Value": "support-workers",
          },
          {
            "Key": "gu:cdk:version",
            "Value": "TEST",
          },
          {
            "Key": "gu:repo",
            "Value": "guardian/support-frontend",
          },
          {
            "Key": "Stack",
            "Value": "support",
          },
          {
            "Key": "Stage",
            "Value": "PROD",
          },
        ],
      },
      "Type": "AWS::IAM::Role",
    },
    "UpdateSupporterProductDataLambdaServiceRoleDefaultPolicyBD75E0D4": {
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": [
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-CODE/catalog.json",
                "arn:aws:s3:::gu-zuora-catalog/PROD/Zuora-PROD/catalog.json",
                "arn:aws:s3:::support-workers-private/*",
              ],
            },
            {
              "Action": [
                "logs:Create*",
                "logs:PutLogEvents",
                "logs:DescribeLogStreams",
                "cloudwatch:putMetricData",
              ],
              "Effect": "Allow",
              "Resource": "*",
            },
            {
              "Action": [
                "dynamodb:PutItem",
                "dynamodb:UpdateItem",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::ImportValue": "supporter-product-data-tables-CODE-SupporterProductDataTable",
                },
                {
                  "Fn::ImportValue": "supporter-product-data-tables-PROD-SupporterProductDataTable",
                },
              ],
            },
            {
              "Action": [
                "s3:GetObject*",
                "s3:GetBucket*",
                "s3:List*",
              ],
              "Effect": "Allow",
              "Resource": [
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                    ],
                  ],
                },
                {
                  "Fn::Join": [
                    "",
                    [
                      "arn:",
                      {
                        "Ref": "AWS::Partition",
                      },
                      ":s3:::",
                      {
                        "Ref": "DistributionBucketName",
                      },
                      "/support/PROD/support-workers/support-workers.jar",
                    ],
                  ],
                },
              ],
            },
            {
              "Action": "ssm:GetParametersByPath",
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers",
                  ],
                ],
              },
            },
            {
              "Action": [
                "ssm:GetParameters",
                "ssm:GetParameter",
              ],
              "Effect": "Allow",
              "Resource": {
                "Fn::Join": [
                  "",
                  [
                    "arn:aws:ssm:",
                    {
                      "Ref": "AWS::Region",
                    },
                    ":",
                    {
                      "Ref": "AWS::AccountId",
                    },
                    ":parameter/PROD/support/support-workers/*",
                  ],
                ],
              },
            },
          ],
          "Version": "2012-10-17",
        },
        "PolicyName": "UpdateSupporterProductDataLambdaServiceRoleDefaultPolicyBD75E0D4",
        "Roles": [
          {
            "Ref": "UpdateSupporterProductDataLambdaServiceRole6A1FC129",
          },
        ],
      },
      "Type": "AWS::IAM::Policy",
    },
  },
}
`;
